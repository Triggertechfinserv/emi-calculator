<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMI Calculator — TechFinserv</title>
  <meta name="description" content="EMI calculator with part-payments. Same header/footer as home. Fast, mobile-friendly, and ad slots confined." />
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- AdSense loader: include ONCE globally -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4180233192929131" crossorigin="anonymous"></script>

  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#f6f9ff; --bg-accent1:rgba(14,165,233,.20); --bg-accent2:rgba(16,185,129,.18);
      --surface:rgba(255,255,255,.78); --surface-strong:rgba(255,255,255,.92);
      --text:#0f172a; --muted:#475569; --border:rgba(2,6,23,.12);
      --accent-1:#0ea5e9; --accent-2:#10b981; --gradient-solid:linear-gradient(135deg,#10a7e6,#10b981);
      --radius:16px; --shadow:0 12px 34px rgba(2,6,23,.10), 0 4px 14px rgba(2,6,23,.06); --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,sans-serif; color:var(--text);
      background: var(--bg);
      -webkit-font-smoothing:antialiased; line-height:1.6;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--maxw); margin:0 auto; padding:0 20px}
    .glass{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      backdrop-filter:blur(10px) saturate(160%); -webkit-backdrop-filter:blur(10px) saturate(160%);
      box-shadow:var(--shadow);}
    /* ===== Header from Home (desktop) ===== */
    .topbar{position:sticky; top:0; z-index:40; background:rgba(255,255,255,.60);
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(14px) saturate(180%); -webkit-backdrop-filter:blur(14px) saturate(180%);
      box-shadow:0 8px 20px rgba(2,6,23,.08); isolation:isolate; overflow:hidden;}
    .topbar::before{content:""; position:absolute; inset:0; pointer-events:none; background:rgba(255,255,255,.55); border-bottom:1px solid var(--border);}
    .topbar::after{content:""; position:absolute; inset:-20% -10%; pointer-events:none;
      background:radial-gradient(1200px 500px at 0% 0%, rgba(14,165,233,.22), transparent 60%),
                 radial-gradient(1200px 500px at 100% 30%, rgba(16,185,129,.22), transparent 60%);}
    header.nav{display:flex; justify-content:space-between; align-items:center; padding:12px 0;}
    .brand-logo{height:65px; border-radius:10px;}
    nav.menu{display:flex; gap:14px}
    nav.menu a{padding:8px 12px; border-radius:10px; color:var(--muted); transition:background .2s}
    nav.menu a:hover{background:var(--surface-strong); color:var(--text)}
    .cta{background:var(--gradient-solid); color:#fff; padding:10px 14px; border-radius:12px; font-weight:600}

    /* Mobile navbar (from Home) */
    .mobile-menu-toggle{display:none}
    .mobile-menu{display:none}
    .mobile-menu.open{display:flex !important}

    /* ===== Page shell ===== */
    main{padding:24px 0 60px}
    .page-title{margin:16px 0 8px; font-size:22px}
    .subtitle{color:var(--muted); font-size:14px}

    /* 2-col layout (desktop) */
    .layout{display:grid; grid-template-columns:2fr 1fr; gap:18px; align-items:start}
    .calc{padding:18px}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    input,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--surface-strong); color:var(--text); outline:none}
    input:focus,select:focus{box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:transparent}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--surface-strong); border:1px solid var(--border)}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; font-weight:700; font-size:13px; cursor:pointer; border:1px solid var(--border); background:var(--surface-strong)}
    .btn:hover{background:rgba(2,6,23,.04)}
    .btn-primary{background:var(--gradient-solid); border:0; color:#fff}
    .btn-danger{background:rgba(239,68,68,.10); color:#b91c1c; border-color:rgba(239,68,68,.35)}
    .btn-success{background:rgba(16,185,129,.12); color:#065f46; border-color:rgba(16,185,129,.35)}

    .summary{display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:12px 0}
    .card{padding:12px 14px; border-radius:14px; background:var(--surface); border:1px solid var(--border)}
    .small-muted{font-size:12px; color:var(--muted)}
    .big{font-size:20px; font-weight:800; letter-spacing:.2px}

    .table-wrap{border-radius:14px; border:1px solid var(--border); overflow:auto; max-height:480px; background:rgba(255,255,255,.5); position:relative}
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{position:sticky; top:0; z-index:10; background:var(--surface-strong); color:var(--muted); text-align:right; font-weight:700; box-shadow:0 1px 0 rgba(2,6,23,.12) inset, 0 2px 8px rgba(2,6,23,.06)}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(2,6,23,.06); text-align:right}
    th:first-child,td:first-child{text-align:left}
    tbody tr:nth-child(odd){background:rgba(2,6,23,.03)}

    /* Right ads (desktop) */
    .ad-card{position:static; padding:16px; display:grid; gap:12px}
    .ad-slot{border:1px dashed var(--border); border-radius:14px; min-height:250px; display:grid; place-items:center; color:var(--muted); background:var(--surface-strong)}
    .ad-note{font-size:12px; color:var(--muted); text-align:center}

    /* Inline horizontal ad above article */
    .inline-ad{margin-top:20px; padding:10px}
    .inline-ad-inner{display:grid; place-items:center; min-height:90px}
    @media (max-width:760px){ #inline-leaderboard{ display:none } } /* hide 728x90 on narrow screens */

    /* Footer (from Home) */
    footer.glass{position:relative; overflow:hidden; background:rgba(255,255,255,.75);
      border-top:1px solid var(--border); backdrop-filter:blur(12px) saturate(170%); -webkit-backdrop-filter:blur(12px) saturate(170%);
      box-shadow:0 -8px 20px rgba(2,6,23,.06) inset;}
    footer.glass::before{content:""; position:absolute; inset:-10% -10% -40% -10%; pointer-events:none;
      background:radial-gradient(900px 400px at 10% 0%, rgba(14,165,233,.20), transparent 60%),
                 radial-gradient(900px 400px at 90% 0%, rgba(16,185,129,.20), transparent 60%);}
    footer.glass::after{content:""; position:absolute; left:0; right:0; top:0; height:2px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); opacity:.8;}
    footer{padding:30px 0 80px; color:var(--muted)}

    /* ===== Mobile optimizations (no blur, 1-column, comfy spacing) ===== */
    @media (max-width:1000px){
      .layout{grid-template-columns:1fr}
      .summary{grid-template-columns:1fr 1fr}
    }
    @media (max-width:640px){
      .grid{grid-template-columns:1fr}
      .summary{grid-template-columns:1fr}
      .big{font-size:18px}
    }
    /* Mobile header/menu mirrors Home page */
    @media (max-width:768px){
      .topbar{background:#ffffffee; backdrop-filter:none!important; -webkit-backdrop-filter:none!important; box-shadow:0 6px 16px rgba(2,6,23,.06)}
      .topbar::before,.topbar::after{display:none!important}
      header.nav{padding:8px 0}
      .brand-logo{height:48px; border-radius:8px}
      nav.menu{display:none}
      .mobile-menu-toggle{display:inline-flex; flex-direction:column; gap:4px; width:28px; height:22px; cursor:pointer; background:transparent; border:0}
      .mobile-menu-toggle span{display:block; height:3px; width:100%; background:var(--text); border-radius:2px}
      .mobile-menu{display:none; flex-direction:column; gap:6px; padding:10px 0 14px; background:#fff; border-bottom:1px solid var(--border)}
      .mobile-menu a{padding:12px 16px; font-size:15px; color:var(--muted)}
      .mobile-menu a:hover{background:var(--bg); color:var(--text)}
      /* Ads: center and full-width containers */
      .ad-card{padding:0}
      .ad-slot{margin:10px 0; border:1px solid var(--border)}
      /* Tables → cards */
      table thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tr{border:1px solid var(--border); border-radius:12px; margin-bottom:10px; padding:10px; background:var(--surface)}
      td{display:flex; justify-content:space-between; align-items:center; padding:6px 0; border:none; text-align:left; font-size:13px}
      td[data-label]:before{content:attr(data-label) ":"; font-weight:600; margin-right:10px; color:var(--muted); width:48%}
      td .value{width:52%; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
      /* Drop heavy blur on cards to avoid jank */
      .glass{background:rgba(255,255,255,.92); backdrop-filter:none!important; -webkit-backdrop-filter:none!important}
      footer.glass{background:#fff; backdrop-filter:none!important; -webkit-backdrop-filter:none!important}
    }
  </style>
</head>
<body>
  <!-- ===== Header (same as Home) ===== -->
  <div class="topbar">
    <div class="container">
      <header class="nav" role="banner">
        <a href="/" aria-label="TechFinserv home">
          <img class="brand-logo" src="images/techfinserv-logo.png" alt="TechFinserv logo">
        </a>

        <!-- Desktop menu -->
        <nav class="menu" aria-label="Primary">
          <a href="/">Home</a>
          <a href="/blogs/">Blog</a>
          <a href="/emi-calculator.html" aria-current="page">EMI calculator</a>
          <a href="#about">About</a>
          <a class="cta" href="coming-soon.html">Apply Now</a>
        </nav>

        <!-- Mobile hamburger -->
        <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu">
          <span></span><span></span><span></span>
        </button>
      </header>

      <!-- Mobile dropdown -->
      <nav id="mobileMenu" class="mobile-menu" aria-label="Mobile">
        <a href="/">Home</a>
        <a href="/blogs/">Blog</a>
        <a href="/emi-calculator.html">EMI calculator</a>
        <a href="#about">About</a>
        <a href="coming-soon.html">Apply Now</a>
      </nav>
    </div>
  </div>

  <main>
    <div class="container">
      <h1 class="page-title">EMI Calculator with Part-Payment</h1>
      <p class="subtitle">Left: calculator. Right: ad space. Mobile-friendly + fast. Ads stay inside their slots only.</p>

      <div class="layout">
        <!-- Left: Calculator -->
        <section id="calculator" class="calc glass" role="region" aria-label="EMI Calculator">
          <div class="grid" style="margin-bottom:12px;">
            <div>
              <label>Loan Amount (Principal)</label>
              <input id="loan" type="number" min="1" value="100000" />
            </div>
            <div>
              <label>Annual Interest Rate (%)</label>
              <input id="rate" type="number" step="0.01" min="0" value="12.50" />
            </div>
            <div>
              <label>Tenure (Years)</label>
              <input id="years" type="number" step="0.25" min="0.1" value="5" />
            </div>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <div style="min-width:220px; flex:1 0 220px;">
              <label>Mode</label>
              <select id="mode">
                <option value="tenure">Reduce Tenure (EMI fixed)</option>
                <option value="emi">Reduce EMI (Tenure fixed)</option>
              </select>
            </div>

            <div style="flex:2; min-width:260px;">
              <label>Add Part Payment (Month & Amount)</label>
              <div class="row">
                <input id="ppMonth" type="number" min="1" placeholder="Month (e.g. 12)" style="max-width:140px" />
                <input id="ppAmount" type="number" min="0" placeholder="Amount (e.g. 100000)" />
                <button id="addPp" class="btn btn-primary" type="button">Add</button>
                <button id="clearPps" class="btn btn-danger" type="button">Clear</button>
              </div>
            </div>
          </div>

          <!-- Part payments list -->
          <div style="margin:10px 0 6px;">
            <div class="small-muted">Part Payments (click remove to delete):</div>
            <div id="paymentsList" class="chips" style="margin-top:8px;"></div>
          </div>

          <!-- KPI cards -->
          <div class="summary" id="dashboard">
            <div class="card"><div class="small-muted">Initial EMI</div><div id="initialEmi" class="big">0</div><div class="small-muted">before prepayment</div></div>
            <div class="card"><div class="small-muted">New Tenure (months)</div><div id="newMonths" class="big">0</div></div>
            <div class="card"><div class="small-muted">Total Interest Paid</div><div id="totalInterest" class="big">0</div></div>
            <div class="card"><div class="small-muted">Total Payment</div><div id="totalPayment" class="big">0</div></div>
          </div>

          <!-- Schedule + exports -->
          <div class="glass" style="padding:14px; margin-top:12px;">
            <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
              <strong>Repayment Schedule</strong>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="downloadXLSX" class="btn btn-success" type="button">Download Excel</button>
                <button id="downloadPDF" class="btn" type="button">Download PDF</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="scheduleTable">
                <thead>
                  <tr><th>Month</th><th>EMI</th><th>Principal</th><th>Interest</th><th>Part Payment</th><th>Outstanding</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <p class="small-muted" style="margin-top:10px;">Tip: Add part payments and choose whether to reduce tenure or EMI. Your table updates instantly.</p>
        </section>

        <!-- Right: Ad space (desktop; becomes full-width blocks on mobile) -->
        <aside class="ad-card glass" aria-label="Ad">
          <!-- first ad RightRail_300x600 (Fixed) -->
          <div class="ad-slot" style="min-height:600px;">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:300px;height:600px"
                 data-ad-client="ca-pub-4180233192929131"
                 data-ad-slot="9154021274"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>

          <!-- second ad 300x250 (Fixed) -->
          <div class="ad-slot" style="min-height:250px;">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:300px;height:250px"
                 data-ad-client="ca-pub-4180233192929131"
                 data-ad-slot="2241854911"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>

          <div class="ad-note">Ads render only inside these boxes.</div>
        </aside>
      </div>

      <!-- Inline Horizontal Ad (728×90 fixed) above article -->
      <section class="inline-ad glass" aria-label="Inline Ad">
        <div class="inline-ad-inner">
          <ins id="inline-leaderboard" class="adsbygoogle"
               style="display:inline-block;width:728px;height:90px"
               data-ad-client="ca-pub-4180233192929131"
               data-ad-slot="3731030557"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
      </section>

      <!-- ===== Learn About EMI (Article) ===== -->
      <section id="learn-emi" class="glass" style="margin-top:20px; padding:18px;">
        <h2 style="margin:0 0 8px;">What is EMI?</h2>
        <p><strong>EMI (Equated Monthly Installment)</strong> is the fixed amount you pay every month until your loan is fully repaid. Each EMI contains interest plus a portion of principal. Early months are interest-heavy; later months are principal-heavy.</p>

        <h3 style="margin:16px 0 8px;">EMI Formula</h3>
        <p class="small-muted">Monthly rate <code>r</code> = Annual rate ÷ 12 ÷ 100; Tenure <code>n</code> = months</p>
        <div class="glass" style="padding:12px;">
          <p style="margin:0;"><strong>EMI</strong> = <code>P × r × (1 + r)<sup>n</sup> ÷ ((1 + r)<sup>n</sup> − 1)</code></p>
          <ul style="margin:8px 0 0 18px; padding:0;">
            <li><code>P</code> = Principal</li>
            <li><code>r</code> = Monthly interest rate</li>
            <li><code>n</code> = Number of monthly installments</li>
          </ul>
        </div>

        <h3 style="margin:16px 0 8px;">Worked Example</h3>
        <p>Borrow <strong>₹10,00,000</strong> @ <strong>10.5% p.a.</strong> for <strong>10 years</strong> (<code>120</code> months). Then <code>r = 10.5 ÷ 12 ÷ 100 = 0.00875</code>.</p>
        <div class="glass" style="padding:12px; margin-bottom:14px;">
          <p style="margin:0;">EMI = <code>10,00,000 × 0.00875 × (1 + 0.00875)<sup>120</sup> ÷ ((1 + 0.00875)<sup>120</sup> − 1)</code> = <strong>₹13,493</strong></p>
          <p style="margin:6px 0 0;">Total paid = <code>₹13,493 × 120 = ₹16,19,220</code> → Interest <strong>₹6,19,220</strong>.</p>
        </div>

        <div class="glass" style="padding:14px; overflow-x:auto; margin-bottom:16px;">
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <thead><tr style="background:rgba(2,6,23,.04);"><th style="padding:8px; text-align:left;">Parameter</th><th style="padding:8px; text-align:right;">Value</th></tr></thead>
            <tbody>
              <tr><td style="padding:8px;">Loan Amount (P)</td><td style="padding:8px; text-align:right;">₹10,00,000</td></tr>
              <tr><td style="padding:8px;">Annual Interest</td><td style="padding:8px; text-align:right;">10.5%</td></tr>
              <tr><td style="padding:8px;">Tenure (n)</td><td style="padding:8px; text-align:right;">120 months</td></tr>
              <tr><td style="padding:8px;">Monthly Rate (r)</td><td style="padding:8px; text-align:right;">0.00875</td></tr>
              <tr><td style="padding:8px;">Calculated EMI</td><td style="padding:8px; text-align:right; font-weight:700;">₹13,493</td></tr>
              <tr><td style="padding:8px;">Total Payment</td><td style="padding:8px; text-align:right;">₹16,19,220</td></tr>
              <tr><td style="padding:8px;">Total Interest</td><td style="padding:8px; text-align:right;">₹6,19,220</td></tr>
            </tbody>
          </table>
        </div>

        <h3 style="margin:16px 0 8px;">How to Use This EMI Calculator</h3>
        <ol style="margin:0 0 0 18px; padding:0;">
          <li>Enter <strong>Loan Amount</strong>, <strong>Annual Interest</strong>, and <strong>Tenure</strong>.</li>
          <li>Choose <strong>Reduce Tenure</strong> (close earlier) or <strong>Reduce EMI</strong> (lower monthly).</li>
          <li>(Optional) Add <strong>Part Payments</strong> by month and amount.</li>
        </ol>
        <p class="small-muted" style="margin-top:8px;">The schedule shows interest/principal split, prepayments, and outstanding balance every month.</p>
      </section>
    </div>
  </main>

  <!-- ===== Footer (same vibe as Home) ===== -->
  <footer id="about" class="glass" style="margin-top:24px;">
    <div class="container">
      Designed & Maintained by Kiran Rathva • © <span id="year"></span> TechFinserv.com
    </div>
  </footer>

  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Mobile menu toggle (same behavior as Home)
    (function () {
      const toggle = document.querySelector('.mobile-menu-toggle');
      const menu = document.getElementById('mobileMenu');
      if (!toggle || !menu) return;

      const setExpanded = (open) => {
        toggle.setAttribute('aria-expanded', String(open));
        menu.classList.toggle('open', open);
      };

      toggle.addEventListener('click', () => setExpanded(!menu.classList.contains('open')));
      menu.addEventListener('click', (e) => { if (e.target.tagName === 'A') setExpanded(false); });
      window.addEventListener('resize', () => { if (window.innerWidth > 768) setExpanded(false); });
    })();

    // ===== Calculator logic (unchanged) =====
    const fmt=(v)=>{const n=Math.round(Number(v)||0);return new Intl.NumberFormat('en-IN',{maximumFractionDigits:0,minimumFractionDigits:0}).format(n);}
    function pmt(rate,nper,pv){if(nper===0)return 0;if(Math.abs(rate)<1e-12)return pv/nper;return (pv*rate)/(1-Math.pow(1+rate,-nper));}
    const loanEl=document.getElementById('loan'),rateEl=document.getElementById('rate'),yearsEl=document.getElementById('years'),modeEl=document.getElementById('mode');
    const ppMonthEl=document.getElementById('ppMonth'),ppAmountEl=document.getElementById('ppAmount'),paymentsList=document.getElementById('paymentsList');
    const initialEmiEl=document.getElementById('initialEmi'),newMonthsEl=document.getElementById('newMonths'),totalInterestEl=document.getElementById('totalInterest'),totalPaymentEl=document.getElementById('totalPayment');
    const scheduleTbody=document.querySelector('#scheduleTable tbody'); const downloadXLSXBtn=document.getElementById('downloadXLSX'); const downloadPDFBtn=document.getElementById('downloadPDF');
    let payments=[];
    function getInputs(){const principal=Math.max(1,Math.round(Number(loanEl.value)||1)); const annualRate=Math.max(0,Number(rateEl.value)||0); const tenureYears=Math.max(0.1,Number(yearsEl.value)||0.1); return {principal,annualRate,tenureYears,monthlyRate:annualRate/12/100,monthsInitial:Math.round(Math.max(1,tenureYears*12))};}
    function renderPayments(){paymentsList.innerHTML=''; payments.forEach((p,idx)=>{const div=document.createElement('div'); div.className='chip'; div.innerHTML=`<div class="small-muted">Month ${p.month} → <strong>${fmt(p.amount)}</strong></div>`; const btn=document.createElement('button'); btn.className='btn btn-danger'; btn.style.padding='6px 10px'; btn.textContent='Remove'; btn.onclick=()=>{payments.splice(idx,1); renderPayments(); computeAndRender();}; div.appendChild(btn); paymentsList.appendChild(div);}); if(payments.length===0) paymentsList.innerHTML='<div class="small-muted">No part payments added.</div>'; }
    function addPayment(){const m=Math.max(1,Math.round(Number(ppMonthEl.value)||0)); const a=Math.max(0,Math.round(Number(ppAmountEl.value)||0)); if(!a){alert('Please enter a part payment amount > 0'); return;} payments.push({month:m,amount:a}); payments.sort((x,y)=>x.month-y.month); ppMonthEl.value=''; ppAmountEl.value=''; renderPayments(); computeAndRender();}
    function clearPayments(){ if(!confirm('Clear all part payments?')) return; payments=[]; renderPayments(); computeAndRender();}
    function computeSchedule(){const {principal,monthlyRate,monthsInitial}=getInputs(); const mode=modeEl.value; const initialEmi=Math.abs(pmt(monthlyRate,monthsInitial,principal));
      function partSum(m){return payments.filter(p=>p.month===m).reduce((s,r)=>s+r.amount,0);}
      const schedule=[]; let outstanding=principal; let emi=initialEmi; let remainingMonths=monthsInitial;
      for(let month=1;month<=1200;month++){ if(outstanding<=0.0001) break; const interest=outstanding*monthlyRate; let principalComp=emi-interest; if(principalComp<0) principalComp=0; const part=partSum(month);
        if(outstanding-principalComp-part<=0){const finalInterest=outstanding*monthlyRate; const finalPrincipal=outstanding; const finalEmi=finalPrincipal+finalInterest;
          schedule.push({month,emi:Math.round(finalEmi),principalPaid:Math.round(finalPrincipal),interestPaid:Math.round(finalInterest),partPayment:Math.round(part),outstanding:0}); outstanding=0; break;}
        outstanding=outstanding-principalComp-part;
        if(mode==='emi' && part>0){ remainingMonths=Math.max(1,monthsInitial-month); if(outstanding>0){ emi=Math.abs(pmt(monthlyRate,remainingMonths,outstanding)); } }
        schedule.push({month,emi:Math.round(emi),principalPaid:Math.round(principalComp),interestPaid:Math.round(interest),partPayment:Math.round(part),outstanding:Math.round(Math.max(0,outstanding))});
        if(month>monthsInitial+600) break;
      }
      return {schedule, initialEmi:Math.round(initialEmi)};
    }
    function computeAndRender(){const {schedule,initialEmi}=computeSchedule(); scheduleTbody.innerHTML=''; schedule.forEach(row=>{const tr=document.createElement('tr');
      const td=(label,val)=>{const el=document.createElement('td'); el.setAttribute('data-label',label); el.innerHTML=`<span class="value">${val}</span>`; return el;};
      tr.appendChild(td('Month',row.month)); tr.appendChild(td('EMI',fmt(row.emi))); tr.appendChild(td('Principal',fmt(row.principalPaid))); tr.appendChild(td('Interest',fmt(row.interestPaid))); tr.appendChild(td('Part Payment',fmt(row.partPayment))); tr.appendChild(td('Outstanding',fmt(row.outstanding))); scheduleTbody.appendChild(tr);});
      const totalInterest=schedule.reduce((s,r)=>s+r.interestPaid,0); const principalInput=Math.max(1,Math.round(Number(loanEl.value)||1)); const totalPayment=totalInterest+principalInput;
      initialEmiEl.textContent=fmt(initialEmi); newMonthsEl.textContent=schedule.length; totalInterestEl.textContent=fmt(totalInterest); totalPaymentEl.textContent=fmt(totalPayment);}
    function exportXLSX(){const {schedule}=computeSchedule(); const hasPart=payments.some(p=>p.amount&&p.amount>0);
      const aoa=[['Loan Amount',loanEl.value],['Annual Rate (%)',rateEl.value],['Tenure (Years)',yearsEl.value],['Mode',modeEl.value],[],];
      if(hasPart){aoa.push(['Month','EMI','Principal Paid','Interest Paid','Part Payment','Outstanding']); schedule.forEach(r=>aoa.push([r.month,r.emi,r.principalPaid,r.interestPaid,r.partPayment,r.outstanding]));}
      else{aoa.push(['Month','EMI','Principal Paid','Interest Paid','Outstanding']); schedule.forEach(r=>aoa.push([r.month,r.emi,r.principalPaid,r.interestPaid,r.outstanding]));}
      const ws=XLSX.utils.aoa_to_sheet(aoa); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Schedule'); const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
      try{saveAs(new Blob([wbout],{type:"application/octet-stream"}),'emi_schedule.xlsx');}catch(e){alert('Excel export failed: '+e.message);}
    }
    function exportPDF(){const {schedule,initialEmi}=computeSchedule(); const loan=Math.round(Number(loanEl.value)||0); const rate=Number(rateEl.value)||0; const years=Number(yearsEl.value)||0; const hasPart=payments.some(p=>p.amount&&p.amount>0);
      const { jsPDF }=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const pageWidth=doc.internal.pageSize.getWidth(); const margin=40; let y=40;
      doc.setFillColor(246,249,255); doc.rect(0,0,pageWidth,60,'F'); doc.setFontSize(18); doc.setTextColor(15,23,42); doc.text('EMI Repayment Schedule',margin,40);
      y=80; const cardW=140, cardH=40, gap=12; const cards=[{label:'Loan Amount',value:fmt(loan),color:[14,165,233]},{label:'Rate (%)',value:String(rate),color:[16,185,129]},{label:'Tenure (yrs)',value:String(years),color:[234,179,8]},{label:'Initial EMI',value:fmt(initialEmi),color:[99,102,241]}];
      let x=margin; cards.forEach(c=>{doc.setFillColor(c.color[0],c.color[1],c.color[2]); doc.roundedRect(x,y,cardW,cardH,6,6,'F'); doc.setTextColor(255,255,255); doc.setFontSize(10); doc.text(c.label,x+10,y+14); doc.setFontSize(13); doc.setFont(undefined,'bold'); doc.text(c.value,x+10,y+30); doc.setFont(undefined,'normal'); x+=cardW+gap;});
      y+=cardH+18; const head=hasPart?[['Month','EMI','Principal','Interest','Part Payment','Outstanding']]:[['Month','EMI','Principal','Interest','Outstanding']];
      const body=schedule.map(r=>hasPart?[r.month,r.emi,r.principalPaid,r.interestPaid,r.partPayment,r.outstanding]:[r.month,r.emi,r.principalPaid,r.interestPaid,r.outstanding]);
      doc.autoTable({startY:y, head, body, styles:{fontSize:9}, headStyles:{fillColor:[245,245,245],textColor:20}, margin:{left:margin,right:margin},
        didDrawPage:function(data){const page=doc.internal.getNumberOfPages(); doc.setFontSize(9); doc.setTextColor(120); doc.text('Page '+page,data.settings.margin.left,doc.internal.pageSize.height-10);},
        theme:'grid'}); doc.save('emi_schedule.pdf');
    }
    document.getElementById('addPp').addEventListener('click',addPayment);
    document.getElementById('clearPps').addEventListener('click',clearPayments);
    [loanEl,rateEl,yearsEl,modeEl].forEach(el=>el.addEventListener('input',computeAndRender));
    downloadXLSXBtn.addEventListener('click',exportXLSX); downloadPDFBtn.addEventListener('click',exportPDF);
    renderPayments(); computeAndRender();
  </script>
</body>
</html>
