<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMI Calculator — TechFinserv</title>
  <meta name="description" content="Smart EMI calculator for home/personal/car loans. Add part-payments to save interest, get a detailed schedule, and download results as PDF/Excel." />
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Third-party libs for export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Styles as before... unchanged for brevity */
    /* ... (your CSS remains unchanged, no optimization needed here) ... */
  </style>
</head>
<body>
  <!-- Header (unchanged) -->
  <div class="topbar">
    <div class="container">
      <!-- ... (header remains unchanged) ... -->
    </div>
  </div>

  <main>
    <div class="container">
      <h1 class="page-title">EMI Calculator with Part-Payment</h1>
      <p class="subtitle">EMI calculator for home, personal and car loans with part-payment support, instant amortization schedule, and one-click PDF/Excel export.</p>

      <div class="layout">
        <!-- Left: Calculator -->
        <section id="calculator" class="calc glass">
          <!-- Inputs as before -->
          <div class="grid" style="margin-bottom:12px;">
            <div>
              <label>Loan Amount (Principal)</label>
              <input id="loan" type="number" min="1" value="100000" />
            </div>
            <div>
              <label>Annual Interest Rate (%)</label>
              <input id="rate" type="number" step="0.01" min="0" value="12.50" />
            </div>
            <div>
              <label>Tenure (Years)</label>
              <input id="years" type="number" step="0.25" min="0.1" value="5" />
            </div>
          </div>

          <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px;">
            <div style="min-width:220px;">
              <label>Mode</label>
              <select id="mode">
                <option value="tenure">Reduce Tenure (EMI fixed)</option>
                <option value="emi">Reduce EMI (Tenure fixed)</option>
              </select>
            </div>

            <div style="flex:1; min-width:260px;">
              <label>Add Part Payment (Month & Amount)</label>
              <div class="row">
                <input id="ppMonth" type="number" min="1" placeholder="Month (e.g. 12)" style="max-width:140px" />
                <input id="ppAmount" type="number" min="0" placeholder="Amount (e.g. 100000)" />
                <button id="addPp" class="btn btn-primary" type="button">Add</button>
                <button id="clearPps" class="btn btn-danger" type="button">Clear</button>
              </div>
            </div>
          </div>

          <div style="margin:10px 0 6px;">
            <div class="small-muted">Part Payments (click remove to delete):</div>
            <div id="paymentsList" class="chips" style="margin-top:8px;"></div>
          </div>

          <div class="summary" id="dashboard">
            <div class="card">
              <div class="small-muted">Initial EMI</div>
              <div id="initialEmi" class="big">0</div>
              <div class="small-muted">before prepayment</div>
            </div>
            <div class="card">
              <div class="small-muted">New Tenure (months)</div>
              <div id="newMonths" class="big">0</div>
            </div>
            <div class="card">
              <div class="small-muted">Total Interest Paid</div>
              <div id="totalInterest" class="big">0</div>
            </div>
            <div class="card">
              <div class="small-muted">Total Payment</div>
              <div id="totalPayment" class="big">0</div>
            </div>
          </div>

          <div class="glass" style="padding:14px; margin-top:12px;">
            <div class="row" style="justify-content: space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
              <strong>Repayment Schedule</strong>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="downloadXLSX" class="btn btn-success" type="button">Download Excel</button>
                <button id="downloadPDF" class="btn" type="button">Download PDF</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="scheduleTable">
                <thead>
                  <tr><th>Month</th><th>EMI</th><th>Principal</th><th>Interest</th><th>Part Payment</th><th>Outstanding</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <p class="small-muted" style="margin-top:10px;">Tip: add one or more part payments (month number & amount). Choose <em>Reduce Tenure</em> to keep EMI the same (loan closes earlier), or <em>Reduce EMI</em> to keep tenure same and reduce monthly payment. Save the file to keep your data.</p>
        </section>

        <!-- Right: Ad space remains unchanged -->
        <!-- ... -->
      </div>

      <!-- Article and other sections unchanged -->
      <!-- ... -->
    </div>
  </main>

  <footer class="glass" style="margin-top:24px;">
    <div class="container">
      Designed & Maintained by Kiran Rathva • © <span id="year"></span> TechFinserv.com
    </div>
  </footer>

  <script>
    // Year update remains unchanged
    document.getElementById('year').textContent = new Date().getFullYear();

    // ======= PERFORMANCE-UPGRADED LOGIC =======
    const fmt = (v) => {
      const n = Math.round(Number(v) || 0);
      return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 }).format(n);
    };

    function pmt(rate, nper, pv) {
      if (nper === 0) return 0;
      if (Math.abs(rate) < 1e-12) return pv / nper;
      return (pv * rate) / (1 - Math.pow(1 + rate, -nper));
    }

    const loanEl = document.getElementById('loan');
    const rateEl = document.getElementById('rate');
    const yearsEl = document.getElementById('years');
    const modeEl = document.getElementById('mode');
    const ppMonthEl = document.getElementById('ppMonth');
    const ppAmountEl = document.getElementById('ppAmount');
    const paymentsList = document.getElementById('paymentsList');
    const initialEmiEl = document.getElementById('initialEmi');
    const newMonthsEl = document.getElementById('newMonths');
    const totalInterestEl = document.getElementById('totalInterest');
    const totalPaymentEl = document.getElementById('totalPayment');
    const scheduleTbody = document.querySelector('#scheduleTable tbody');
    const downloadXLSXBtn = document.getElementById('downloadXLSX');
    const downloadPDFBtn = document.getElementById('downloadPDF');

    let payments = []; // {month, amount}
    let lastSchedule = null;
    let lastInitialEmi = 0;

    function getInputs() {
      const principal = Math.max(1, Math.round(Number(loanEl.value) || 1));
      const annualRate = Math.max(0, Number(rateEl.value) || 0);
      const tenureYears = Math.max(0.1, Number(yearsEl.value) || 0.1);
      return { principal, annualRate, tenureYears, monthlyRate: annualRate/12/100, monthsInitial: Math.round(Math.max(1, tenureYears*12)) };
    }

    function renderPayments() {
      if (payments.length === 0) {
        paymentsList.innerHTML = '<div class="small-muted">No part payments added.</div>';
        return;
      }
      let html = '';
      payments.forEach((p, idx) => {
        html += `<div class="chip"><div class="small-muted">Month ${p.month} → <strong>${fmt(p.amount)}</strong></div>
                <button data-rm="${idx}" class="btn btn-danger" style="padding:6px 10px">Remove</button></div>`;
      });
      paymentsList.innerHTML = html;
      paymentsList.querySelectorAll('button[data-rm]').forEach(btn => {
        btn.onclick = () => { payments.splice(Number(btn.getAttribute('data-rm')),1); renderPayments(); resetPage(); computeAndRender(); };
      });
    }

    function addPayment() {
      const m = Math.max(1, Math.round(Number(ppMonthEl.value) || 0));
      const a = Math.max(0, Math.round(Number(ppAmountEl.value) || 0));
      if (!a) { alert('Please enter a part payment amount > 0'); return; }
      payments.push({month:m, amount:a});
      payments.sort((x,y)=>x.month-y.month);
      ppMonthEl.value=''; ppAmountEl.value='';
      renderPayments();
      resetPage(); computeAndRender();
    }

    function clearPayments(){
      if(!confirm('Clear all part payments?')) return;
      payments = [];
      renderPayments();
      resetPage(); computeAndRender();
    }

    // Pagination variables
    const PAGE_SIZE = 200;
    let currentPage = 1;
    function resetPage() { currentPage = 1; }

    function computeSchedule() {
      const { principal, monthlyRate, monthsInitial } = getInputs();
      const mode = modeEl.value;
      const initialEmi = Math.abs(pmt(monthlyRate, monthsInitial, principal));
      const partMap = new Map();
      for (const p of payments) partMap.set(p.month, (partMap.get(p.month)||0) + p.amount);

      const schedule = [];
      let outstanding = principal;
      let emi = initialEmi;
      let remainingMonths = monthsInitial;

      for (let month=1; month<=1200; month++) {
        if (outstanding <= 0.0001) break;
        const interest = outstanding * monthlyRate;
        let principalComp = emi - interest;
        if (principalComp < 0) principalComp = 0;
        const part = partMap.get(month) || 0;
        if (outstanding - principalComp - part <= 0) {
          const finalInterest = outstanding * monthlyRate;
          const finalPrincipal = outstanding;
          const finalEmi = finalPrincipal + finalInterest;
          schedule.push({ month, emi: Math.round(finalEmi), principalPaid: Math.round(finalPrincipal), interestPaid: Math.round(finalInterest), partPayment: Math.round(part), outstanding: 0 });
          outstanding = 0;
          break;
        }
        outstanding = outstanding - principalComp - part;
        if (mode === 'emi' && part > 0) {
          remainingMonths = Math.max(1, monthsInitial - month);
          if (outstanding > 0) {
            emi = Math.abs(pmt(monthlyRate, remainingMonths, outstanding));
          }
        }
        schedule.push({ month, emi: Math.round(emi), principalPaid: Math.round(principalComp), interestPaid: Math.round(interest), partPayment: Math.round(part), outstanding: Math.round(Math.max(0, outstanding)) });
        if (month > monthsInitial + 600) break;
      }
      return { schedule, initialEmi: Math.round(initialEmi) };
    }

    function renderSchedule(schedule) {
      // Sliced rows for pagination
      const start = 0;
      const end = Math.min(schedule.length, PAGE_SIZE * currentPage);
      let rows = '';
      for (let i = start; i < end; i++) {
        const r = schedule[i];
        rows += `<tr>
          <td data-label="Month"><span class="value">${r.month}</span></td>
          <td data-label="EMI"><span class="value">${fmt(r.emi)}</span></td>
          <td data-label="Principal"><span class="value">${fmt(r.principalPaid)}</span></td>
          <td data-label="Interest"><span class="value">${fmt(r.interestPaid)}</span></td>
          <td data-label="Part Payment"><span class="value">${fmt(r.partPayment)}</span></td>
          <td data-label="Outstanding"><span class="value">${fmt(r.outstanding)}</span></td>
        </tr>`;
      }
      scheduleTbody.innerHTML = rows;
      // Show More button
      if (end < schedule.length) {
        scheduleTbody.innerHTML += `<tr><td colspan="6" style="text-align:center">
          <button class="btn btn-primary" id="showMoreRows">Show More</button>
        </td></tr>`;
        document.getElementById('showMoreRows').onclick = function() {
          currentPage++; renderSchedule(schedule);
        };
      }
    }

    function updateKpis(schedule, initialEmi){
      const totalInterest = schedule.reduce((s,r)=>s+r.interestPaid, 0);
      const principalInput = Math.max(1, Math.round(Number(loanEl.value) || 1));
      const totalPayment = totalInterest + principalInput;
      initialEmiEl.textContent = fmt(initialEmi);
      newMonthsEl.textContent = schedule.length;
      totalInterestEl.textContent = fmt(totalInterest);
      totalPaymentEl.textContent = fmt(totalPayment);
    }

    function computeAndRender(){
      const { schedule, initialEmi } = computeSchedule();
      lastSchedule = schedule;
      lastInitialEmi = initialEmi;
      renderSchedule(schedule);
      updateKpis(schedule, initialEmi);
    }

    // Debounce utility for inputs
    function debounce(func, delay) {
      let timer = null;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // Setup event listeners with debounce
    const debouncedUpdate = debounce(() => { resetPage(); computeAndRender(); }, 120);
    [loanEl, rateEl, yearsEl, modeEl].forEach(el =>
      el.addEventListener('input', debouncedUpdate)
    );

    document.getElementById('addPp').addEventListener('click', addPayment);
    document.getElementById('clearPps').addEventListener('click', clearPayments);

    // Export functions remain unchanged, but use lastSchedule
    function exportXLSX(){
      const schedule = lastSchedule || computeSchedule().schedule;
      const hasPart = payments.some(p => p.amount && p.amount > 0);
      const aoa = [ ['Loan Amount', loanEl.value], ['Annual Rate (%)', rateEl.value], ['Tenure (Years)', yearsEl.value], ['Mode', modeEl.value], [], ];
      if (hasPart) {
        aoa.push(['Month','EMI','Principal Paid','Interest Paid','Part Payment','Outstanding']);
        schedule.forEach(r => aoa.push([r.month, r.emi, r.principalPaid, r.interestPaid, r.partPayment, r.outstanding]));
      } else {
        aoa.push(['Month','EMI','Principal Paid','Interest Paid','Outstanding']);
        schedule.forEach(r => aoa.push([r.month, r.emi, r.principalPaid, r.interestPaid, r.outstanding]));
      }
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Schedule');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      try { saveAs(new Blob([wbout],{type:"application/octet-stream"}), 'emi_schedule.xlsx'); } catch(e) { alert('Excel export failed: ' + e.message); }
    }

    function exportPDF(){
      const scheduleData = lastSchedule || computeSchedule().schedule;
      const initialEmi = lastInitialEmi || computeSchedule().initialEmi;
      const loan = Math.round(Number(loanEl.value) || 0);
      const rate = Number(rateEl.value) || 0;
      const years = Number(yearsEl.value) || 0;
      const hasPart = payments.some(p => p.amount && p.amount > 0);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let y = 40;
      doc.setFillColor(246, 249, 255);
      doc.rect(0,0,pageWidth,60,'F');
      doc.setFontSize(18);
      doc.setTextColor(15,23,42);
      doc.text('EMI Repayment Schedule', margin, 40);
      y = 80;
      const cardW = 140; const cardH = 40; const gap = 12;
      const cards = [
        {label:'Loan Amount', value: fmt(loan), color: [14,165,233]},
        {label:'Rate (%)', value: String(rate), color: [16,185,129]},
        {label:'Tenure (yrs)', value: String(years), color: [234,179,8]},
        {label:'Initial EMI', value: fmt(initialEmi), color: [99,102,241]}
      ];
      let x = margin;
      cards.forEach(c=>{
        doc.setFillColor(c.color[0], c.color[1], c.color[2]);
        doc.roundedRect(x, y, cardW, cardH, 6, 6, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(10);
        doc.text(c.label, x + 10, y + 14);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.text(c.value, x + 10, y + 30);
        doc.setFont(undefined, 'normal');
        x += cardW + gap;
      });
      y += cardH + 18;
      const head = hasPart ? [['Month','EMI','Principal','Interest','Part Payment','Outstanding']] : [['Month','EMI','Principal','Interest','Outstanding']];
      const body = scheduleData.map(r => hasPart ? [r.month, r.emi, r.principalPaid, r.interestPaid, r.partPayment, r.outstanding] : [r.month, r.emi, r.principalPaid, r.interestPaid, r.outstanding]);
      doc.autoTable({
        startY: y,
        head: head,
        body: body,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: margin, right: margin },
        didDrawPage: function (data) {
          const page = doc.internal.getNumberOfPages();
          doc.setFontSize(9);
          doc.setTextColor(120);
          doc.text('Page ' + page, data.settings.margin.left, doc.internal.pageSize.height - 10);
        },
        theme: 'grid'
      });
      doc.save('emi_schedule.pdf');
    }

    downloadXLSXBtn.addEventListener('click', exportXLSX);
    downloadPDFBtn.addEventListener('click', exportPDF);

    // First render
    renderPayments();
    computeAndRender();
  </script>
</body>
</html>
