<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMI Calculator â€” TechFinserv</title>
  <meta name="description" content="EMI calculator with part-payment options. Styled to match TechFinserv with mobile-friendly header/footer and fixed-size ad slots." />

  <!-- Favicon / Fonts -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- AdSense loader: include ONCE -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4180233192929131" crossorigin="anonymous"></script>

  <!-- Export libs (Excel/PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#f6f9ff; --bg-accent1:rgba(14,165,233,.20); --bg-accent2:rgba(16,185,129,.18);
      --surface:rgba(255,255,255,.78); --surface-strong:rgba(255,255,255,.92);
      --text:#0f172a; --muted:#475569; --border:rgba(2,6,23,.12);
      --accent-1:#0ea5e9; --accent-2:#10b981; --gradient-solid:linear-gradient(135deg,#10a7e6,#10b981);
      --radius:16px; --shadow:0 12px 34px rgba(2,6,23,.10), 0 4px 14px rgba(2,6,23,.06);
      --maxw:1200px;

      --input-bg: rgba(255,255,255,0.92);
      --input-focus: rgba(14,165,233,0.25);
      --table-stripe: rgba(2,6,23,0.03);
      --table-head: rgba(2,6,23,0.04);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, sans-serif; color: var(--text);
      background: var(--bg); line-height: 1.6; -webkit-font-smoothing: antialiased;
    }
    /* Blue+green background (raster for perf) */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" preserveAspectRatio="none"><defs><radialGradient id="b" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(120 40) scale(900 500)"><stop offset="0" stop-color="%230ea5e9" stop-opacity="0.20"/><stop offset="0.6" stop-color="%230ea5e9" stop-opacity="0"/></radialGradient><radialGradient id="g" cx="1" cy="0.3" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(1080 240) scale(900 500)"><stop offset="0" stop-color="%2310b981" stop-opacity="0.18"/><stop offset="0.6" stop-color="%2310b981" stop-opacity="0"/></radialGradient></defs><rect width="1200" height="800" fill="%23f6f9ff"/><rect width="1200" height="800" fill="url(%23b)"/><rect width="1200" height="800" fill="url(%23g)"/></svg>');
      background-size:cover; background-repeat:no-repeat; background-position:center;
    }

    a { color: inherit; text-decoration: none; }
    .container { max-width: var(--maxw); margin: 0 auto; padding: 0 20px; }

    .glass { background: var(--surface); border: 1px solid var(--border);
      backdrop-filter: blur(10px) saturate(160%); -webkit-backdrop-filter: blur(10px) saturate(160%);
      box-shadow: var(--shadow); border-radius: var(--radius); }

    /* ===== Header (same as Home) ===== */
    .topbar {
      position: sticky; top: 0; z-index: 40;
      background: rgba(255,255,255,0.78);
      border-bottom: 1px solid var(--border);
      backdrop-filter: none !important; -webkit-backdrop-filter: none !important;
      box-shadow: 0 6px 16px rgba(2,6,23,0.06); overflow: hidden;
    }
    .topbar::before { content:""; position:absolute; inset:0; pointer-events:none;
      background: rgba(255,255,255,0.55); border-bottom:1px solid var(--border); }
    .topbar::after {
      content:""; position:absolute; inset:-20% -10%; pointer-events:none;
      background:
        radial-gradient(900px 360px at 0% 0%, rgba(14,165,233,0.16), transparent 60%),
        radial-gradient(900px 360px at 100% 30%, rgba(16,185,129,0.16), transparent 60%);
    }
    header.nav { display:flex; justify-content:space-between; align-items:center; padding:12px 0; }
    .brand-logo { height: 65px; border-radius: 10px; }
    nav.menu { display:flex; gap:14px; }
    nav.menu a { padding:8px 12px; border-radius:10px; color:var(--muted); transition:background .2s; font-size:15px; }
    nav.menu a:hover { background: rgba(255,255,255,0.92); color: var(--text); box-shadow: 0 6px 12px rgba(2,6,23,0.06); }
    .cta { background: var(--gradient-solid); color:#fff; padding:10px 14px; border-radius:12px; font-weight:600; }
    .mobile-menu-toggle { display:none; }
    .mobile-menu { display:none; }

    main { padding: 24px 0 60px; }
    h1.page-title { margin: 16px 0 8px; font-size: 24px; }
    .subtitle { color: var(--muted); font-size: 14px; }

    /* Layout */
    .layout{ display:grid; grid-template-columns: 2fr 1fr; gap:18px; align-items:start; }
    @media (max-width:1100px){ .layout{ grid-template-columns: 1.4fr .8fr; } }
    @media (max-width:1000px){ .layout{ grid-template-columns: 1fr; } }

    /* Calculator */
    .calc { padding:18px; }
    .grid { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
    label { font-size:12px; color:var(--muted); display:block; margin:0 0 6px; }
    input, select { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: var(--input-bg); color: var(--text); outline:none; }
    input:focus, select:focus { box-shadow: 0 0 0 3px var(--input-focus); border-color: transparent; }

    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; font-weight:700; font-size:13px; cursor:pointer; border:1px solid var(--border); background: var(--surface-strong); color: var(--text); }
    .btn:hover { background: rgba(2,6,23,0.04); }
    .btn-primary { background: var(--gradient-solid); border: 0; color: #fff; }
    .btn-danger { background: rgba(239,68,68,0.10); color: #b91c1c; border-color: rgba(239,68,68,0.35); }
    .btn-success { background: rgba(16,185,129,0.12); color: #065f46; border-color: rgba(16,185,129,0.35); }

    /* Part payment responsive row */
    .pp-row{ margin:12px 0 6px; }
    .pp-field label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    .pp-grid{ display:grid; grid-template-columns: 140px 1fr auto auto; gap:10px; align-items:center; }
    .pp-grid .btn{ height:40px; padding:0 14px; }
    @media (max-width:900px){ .pp-grid{ grid-template-columns: 1fr 1fr; } .pp-grid .btn{ width:100%; } }
    @media (max-width:560px){ .pp-grid{ grid-template-columns: 1fr; } }

    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background: var(--surface-strong); border:1px solid var(--border); }

    .summary { display:grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin: 12px 0; }
    .card { padding: 12px 14px; border-radius: 14px; background: var(--surface); border: 1px solid var(--border); }
    .small-muted { font-size: 12px; color: var(--muted); }
    .big { font-size: 20px; font-weight: 800; letter-spacing: 0.2px; }
    @media (max-width: 1000px) { .summary { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px)  { .summary { grid-template-columns: 1fr; } .big{ font-size:18px; } .grid{ grid-template-columns:1fr; } }

    .table-wrap { border-radius: 14px; border: 1px solid var(--border); overflow: auto; max-height: 480px; background: rgba(255,255,255,0.5); position:relative; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th { position: sticky; top: 0; z-index: 10; background: var(--surface-strong); color: var(--muted); text-align: right; font-weight: 700; box-shadow: 0 1px 0 rgba(2,6,23,0.12) inset, 0 2px 8px rgba(2,6,23,0.06); }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(2,6,23,0.06); text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    tbody tr:nth-child(odd) { background: var(--table-stripe); }

    /* Mobile table -> cards */
    @media (max-width: 600px) {
      table thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; }
      tr { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; padding: 10px; background: var(--surface); }
      td { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border: none; text-align: left; font-size: 13px; color: var(--text); }
      td[data-label]:before { content: attr(data-label) ":"; font-weight: 600; margin-right: 10px; color: var(--muted); width: 40%; max-width: 160px; }
      td .value { width: 60%; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    }

    /* Ads */
    .ad-card { position: static; padding: 16px; display: grid; gap: 12px; }
    .ad-slot { border: 1px dashed var(--border); border-radius: 14px; display: grid; place-items: center; color: var(--muted); background: var(--surface-strong); padding:10px; }
    .ad-note { font-size: 12px; color: var(--muted); text-align:center; }

    footer { border-top: 1px solid var(--border); padding: 30px 0 80px; color: var(--muted); background: rgba(255,255,255,0.85); }

    /* Mobile header/footer */
    @media (max-width: 768px) {
      .brand-logo { height: 48px; border-radius: 8px; }
      nav.menu { display:none; }
      .mobile-menu-toggle {
        display: inline-flex; flex-direction: column; justify-content: center; gap: 4px;
        width: 28px; height: 22px; cursor: pointer; background: transparent; border: 0;
      }
      .mobile-menu-toggle span { display:block; height:3px; width:100%; background:var(--text); border-radius:2px; }
      .mobile-menu { display:none; flex-direction:column; gap:6px; padding:10px 0 14px; background:#fff; border-bottom:1px solid var(--border); }
      .mobile-menu a { padding:12px 16px; font-size:15px; color:var(--muted); }
      .mobile-menu a:hover { background: var(--bg); color: var(--text); }
      footer { padding: 22px 0 56px; }
    }
    .mobile-menu.open { display:flex !important; }
  </style>
</head>
<body>
  <!-- Header (same as Home) -->
  <div class="topbar">
    <div class="container">
      <header class="nav" role="banner">
        <a href="/" aria-label="TechFinserv home">
          <img class="brand-logo" src="images/techfinserv-logo.png" alt="TechFinserv logo">
        </a>
        <nav class="menu" aria-label="Primary">
          <a href="/">Home</a>
          <a href="/blogs/">Blog</a>
          <a href="/emi-calculator.html" aria-current="page">EMI calculator</a>
          <a href="#about">About</a>
          <a class="cta" href="coming-soon.html">Apply Now</a>
        </nav>
        <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu">
          <span></span><span></span><span></span>
        </button>
      </header>
      <nav id="mobileMenu" class="mobile-menu" aria-label="Mobile">
        <a href="/">Home</a>
        <a href="/blogs/">Blog</a>
        <a href="/emi-calculator.html">EMI calculator</a>
        <a href="#about">About</a>
        <a href="coming-soon.html">Apply Now</a>
      </nav>
    </div>
  </div>

  <main>
    <div class="container">
      <h1 class="page-title">EMI Calculator with Part-Payment</h1>
      <p class="subtitle">Left: calculator. Right: ad space. Mobile-friendly + fast. Ads stay inside their slots only.</p>

      <div class="layout">
        <!-- Left: Calculator -->
        <section id="calculator" class="calc glass" role="region" aria-label="EMI Calculator">
          <!-- Inputs -->
          <div class="grid" style="margin-bottom:12px;">
            <div>
              <label for="loan">Loan Amount (Principal)</label>
              <input id="loan" type="number" min="1" value="100000" />
            </div>
            <div>
              <label for="rate">Annual Interest Rate (%)</label>
              <input id="rate" type="number" step="0.01" min="0" value="12.50" />
            </div>
            <div>
              <label for="years">Tenure (Years)</label>
              <input id="years" type="number" step="0.25" min="0.1" value="5" />
            </div>
          </div>

          <!-- Part payment responsive row -->
          <div class="pp-row">
            <div class="pp-field">
              <label for="ppMonth">Add Part Payment (Month & Amount)</label>
              <div class="pp-grid">
                <input id="ppMonth" type="number" min="1" placeholder="Month (e.g. 12)">
                <input id="ppAmount" type="number" min="0" placeholder="Amount (e.g. 100000)">
                <button id="addPp" class="btn btn-primary" type="button">Add</button>
                <button id="clearPps" class="btn btn-danger" type="button">Clear</button>
              </div>
            </div>
          </div>

          <!-- Mode -->
          <div style="margin:10px 0 6px;">
            <label for="mode">Mode</label>
            <select id="mode" style="max-width:360px">
              <option value="tenure">Reduce Tenure (EMI fixed)</option>
              <option value="emi">Reduce EMI (Tenure fixed)</option>
            </select>
          </div>

          <!-- Part payments list -->
          <div style="margin:10px 0 6px;">
            <div class="small-muted">Part Payments (click remove to delete):</div>
            <div id="paymentsList" class="chips" style="margin-top:8px;"></div>
          </div>

          <!-- KPI cards -->
          <div class="summary" id="dashboard">
            <div class="card">
              <div class="small-muted">Initial EMI</div>
              <div id="initialEmi" class="big">0</div>
              <div class="small-muted">before prepayment</div>
            </div>
            <div class="card">
              <div class="small-muted">New Tenure (months)</div>
              <div id="newMonths" class="big">0</div>
            </div>
            <div class="card">
              <div class="small-muted">Total Interest Paid</div>
              <div id="totalInterest" class="big">0</div>
            </div>
            <div class="card">
              <div class="small-muted">Total Payment</div>
              <div id="totalPayment" class="big">0</div>
            </div>
          </div>

          <!-- Schedule + exports -->
          <div class="glass" style="padding:14px; margin-top:12px;">
            <div class="btn-row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
              <strong>Repayment Schedule</strong>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="downloadXLSX" class="btn btn-success" type="button">Download Excel</button>
                <button id="downloadPDF" class="btn" type="button">Download PDF</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="scheduleTable">
                <thead>
                  <tr><th>Month</th><th>EMI</th><th>Principal</th><th>Interest</th><th>Part Payment</th><th>Outstanding</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <p class="small-muted" style="margin-top:10px;">Tip: add one or more part payments (month number & amount). Choose <em>Reduce Tenure</em> to keep EMI the same (loan closes earlier), or <em>Reduce EMI</em> to keep tenure same and reduce monthly payment. Save the file to keep your data.</p>
        </section>

        <!-- Right: Ad space -->
        <aside class="ad-card glass" aria-label="Ad">
          <!-- first ad RightRail_300x600 (Fixed) -->
          <div class="ad-slot" style="min-height:600px;">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:300px;height:600px"
                 data-ad-client="ca-pub-4180233192929131"
                 data-ad-slot="9154021274"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>

          <!-- second ad TopBanner_300x250 (Fixed) -->
          <div class="ad-slot" style="min-height:250px;">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:300px;height:250px"
                 data-ad-client="ca-pub-4180233192929131"
                 data-ad-slot="2241854911"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
          </div>

          <div class="ad-note">Ads render only in these boxes.</div>
        </aside>
      </div>

      <!-- Inline 728Ã—90 ad just above article -->
      <section class="glass" style="margin-top:22px; padding:18px;">
        <div style="display:grid; place-items:center;">
          <ins class="adsbygoogle"
               style="display:inline-block;width:728px;height:90px;max-width:100%"
               data-ad-client="ca-pub-4180233192929131"
               data-ad-slot="3731030557"></ins>
        </div>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </section>

      <!-- Article placeholder -->
      <section id="learn-emi" class="glass" style="margin-top:18px; padding:18px;">
        <h2 style="margin-top:0;">What is EMI?</h2>
        <p>Equated Monthly Installment (EMI) is the fixed amount you pay each month towards a loan. Every EMI contains two parts â€” interest and principal. In the early months, the interest portion is higher; over time, principal share increases.</p>
        <p><strong>Formula:</strong> EMI = P Ã— r Ã— (1+r)<sup>n</sup> / [(1+r)<sup>n</sup> âˆ’ 1], where P = principal, r = monthly rate (annual%/12/100), n = number of months.</p>
        <p>Use the inputs above and add part-payments to see how your tenure or EMI changes instantly.</p>
      </section>
    </div>
  </main>

  <footer id="about" class="glass" style="margin-top:24px;">
    <div class="container">
      Designed & Maintained by Kiran Rathva â€¢ Â© <span id="year"></span> TechFinserv.com
    </div>
  </footer>

  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Mobile menu toggle (same as Home)
    (function () {
      const toggle = document.querySelector('.mobile-menu-toggle');
      const menu = document.getElementById('mobileMenu');
      if (!toggle || !menu) return;
      const setExpanded = (open) => {
        toggle.setAttribute('aria-expanded', String(open));
        menu.classList.toggle('open', open);
      };
      toggle.addEventListener('click', () => setExpanded(!menu.classList.contains('open')));
      menu.addEventListener('click', (e) => { if (e.target.tagName === 'A') setExpanded(false); });
      window.addEventListener('resize', () => { if (window.innerWidth > 768) setExpanded(false); });
    })();

    // =============================
    // EMI CALCULATOR LOGIC
    // =============================
    const fmt = (v) => {
      const n = Math.round(Number(v) || 0);
      return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 }).format(n);
    };
    function pmt(rate, nper, pv) {
      if (nper === 0) return 0;
      if (Math.abs(rate) < 1e-12) return pv / nper;
      return (pv * rate) / (1 - Math.pow(1 + rate, -nper));
    }

    // DOM
    const loanEl = document.getElementById('loan');
    const rateEl = document.getElementById('rate');
    const yearsEl = document.getElementById('years');
    const modeEl = document.getElementById('mode');

    const ppMonthEl = document.getElementById('ppMonth');
    const ppAmountEl = document.getElementById('ppAmount');
    const paymentsList = document.getElementById('paymentsList');

    const initialEmiEl = document.getElementById('initialEmi');
    const newMonthsEl = document.getElementById('newMonths');
    const totalInterestEl = document.getElementById('totalInterest');
    const totalPaymentEl = document.getElementById('totalPayment');

    const scheduleTbody = document.querySelector('#scheduleTable tbody');
    const downloadXLSXBtn = document.getElementById('downloadXLSX');
    const downloadPDFBtn = document.getElementById('downloadPDF');

    let payments = []; // {month, amount}

    function getInputs() {
      const principal = Math.max(1, Math.round(Number(loanEl.value) || 1));
      const annualRate = Math.max(0, Number(rateEl.value) || 0);
      const tenureYears = Math.max(0.1, Number(yearsEl.value) || 0.1);
      return { principal, annualRate, tenureYears, monthlyRate: annualRate/12/100, monthsInitial: Math.round(Math.max(1, tenureYears*12)) };
    }

    function renderPayments() {
      paymentsList.innerHTML = '';
      payments.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `<div class="small-muted">Month ${p.month} â†’ <strong>${fmt(p.amount)}</strong></div>`;
        const btn = document.createElement('button');
        btn.className = 'btn btn-danger';
        btn.style.padding = '6px 10px';
        btn.textContent = 'Remove';
        btn.onclick = () => { payments.splice(idx,1); renderPayments(); computeAndRender(); };
        div.appendChild(btn);
        paymentsList.appendChild(div);
      });
      if (payments.length===0) paymentsList.innerHTML = '<div class="small-muted">No part payments added.</div>';
    }

    function addPayment() {
      const m = Math.max(1, Math.round(Number(ppMonthEl.value) || 0));
      const a = Math.max(0, Math.round(Number(ppAmountEl.value) || 0));
      if (!a) { alert('Please enter a part payment amount > 0'); return; }
      payments.push({month:m, amount:a});
      payments.sort((x,y)=>x.month-y.month);
      ppMonthEl.value=''; ppAmountEl.value='';
      renderPayments();
      computeAndRender();
    }

    function clearPayments(){
      if(!confirm('Clear all part payments?')) return;
      payments = [];
      renderPayments();
      computeAndRender();
    }

    function computeSchedule() {
      const { principal, monthlyRate, monthsInitial } = getInputs();
      const mode = modeEl.value; // 'tenure' or 'emi'
      const initialEmi = Math.abs(pmt(monthlyRate, monthsInitial, principal));
      function partSum(m) { return payments.filter(p=>p.month===m).reduce((s,r)=>s+r.amount,0); }

      const schedule = [];
      let outstanding = principal;
      let emi = initialEmi;
      let remainingMonths = monthsInitial;

      for (let month=1; month<=1200; month++) {
        if (outstanding <= 0.0001) break;
        const interest = outstanding * monthlyRate;
        let principalComp = emi - interest;
        if (principalComp < 0) principalComp = 0;

        const part = partSum(month);

        if (outstanding - principalComp - part <= 0) {
          const finalInterest = outstanding * monthlyRate;
          const finalPrincipal = outstanding;
          const finalEmi = finalPrincipal + finalInterest;
          schedule.push({ month, emi: Math.round(finalEmi), principalPaid: Math.round(finalPrincipal), interestPaid: Math.round(finalInterest), partPayment: Math.round(part), outstanding: 0 });
          outstanding = 0;
          break;
        }

        outstanding = outstanding - principalComp - part;

        if (mode === 'emi' && part > 0) {
          remainingMonths = Math.max(1, monthsInitial - month);
          if (outstanding > 0) {
            emi = Math.abs(pmt(monthlyRate, remainingMonths, outstanding));
          }
        }

        schedule.push({ month, emi: Math.round(emi), principalPaid: Math.round(principalComp), interestPaid: Math.round(interest), partPayment: Math.round(part), outstanding: Math.round(Math.max(0, outstanding)) });

        if (month > monthsInitial + 600) break;
      }

      return { schedule, initialEmi: Math.round(initialEmi) };
    }

    function computeAndRender(){
      const { schedule, initialEmi } = computeSchedule();

      scheduleTbody.innerHTML = '';
      schedule.forEach(row=>{
        const tr = document.createElement('tr');

        const tdMonth = document.createElement('td');
        tdMonth.setAttribute('data-label','Month');
        tdMonth.innerHTML = `<span class="value">${row.month}</span>`;
        tr.appendChild(tdMonth);

        const tdEmi = document.createElement('td');
        tdEmi.setAttribute('data-label','EMI');
        tdEmi.innerHTML = `<span class="value">${fmt(row.emi)}</span>`;
        tr.appendChild(tdEmi);

        const tdPrincipal = document.createElement('td');
        tdPrincipal.setAttribute('data-label','Principal');
        tdPrincipal.innerHTML = `<span class="value">${fmt(row.principalPaid)}</span>`;
        tr.appendChild(tdPrincipal);

        const tdInterest = document.createElement('td');
        tdInterest.setAttribute('data-label','Interest');
        tdInterest.innerHTML = `<span class="value">${fmt(row.interestPaid)}</span>`;
        tr.appendChild(tdInterest);

        const tdPart = document.createElement('td');
        tdPart.setAttribute('data-label','Part Payment');
        tdPart.innerHTML = `<span class="value">${fmt(row.partPayment)}</span>`;
        tr.appendChild(tdPart);

        const tdOut = document.createElement('td');
        tdOut.setAttribute('data-label','Outstanding');
        tdOut.innerHTML = `<span class="value">${fmt(row.outstanding)}</span>`;
        tr.appendChild(tdOut);

        scheduleTbody.appendChild(tr);
      });

      // Totals
      const totalInterest = schedule.reduce((s,r)=>s+r.interestPaid, 0);
      const principalInput = Math.max(1, Math.round(Number(loanEl.value) || 1));
      const totalPayment = totalInterest + principalInput;

      initialEmiEl.textContent = fmt(initialEmi);
      newMonthsEl.textContent = schedule.length;
      totalInterestEl.textContent = fmt(totalInterest);
      totalPaymentEl.textContent = fmt(totalPayment);
    }

    function exportXLSX(){
      const { schedule } = computeSchedule();
      const hasPart = payments.some(p => p.amount && p.amount > 0);
      const aoa = [ ['Loan Amount', loanEl.value], ['Annual Rate (%)', rateEl.value], ['Tenure (Years)', yearsEl.value], ['Mode', modeEl.value], [], ];
      if (hasPart) {
        aoa.push(['Month','EMI','Principal Paid','Interest Paid','Part Payment','Outstanding']);
        schedule.forEach(r => aoa.push([r.month, r.emi, r.principalPaid, r.interestPaid, r.partPayment, r.outstanding]));
      } else {
        aoa.push(['Month','EMI','Principal Paid','Interest Paid','Outstanding']);
        schedule.forEach(r => aoa.push([r.month, r.emi, r.principalPaid, r.interestPaid, r.outstanding]));
      }
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Schedule');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      try { saveAs(new Blob([wbout],{type:"application/octet-stream"}), 'emi_schedule.xlsx'); } catch(e) { alert('Excel export failed: ' + e.message); }
    }

    function exportPDF(){
      const { schedule, initialEmi } = computeSchedule();
      const loan = Math.round(Number(loanEl.value) || 0);
      const rate = Number(rateEl.value) || 0;
      const years = Number(yearsEl.value) || 0;
      const hasPart = payments.some(p => p.amount && p.amount > 0);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 40;
      let y = 40;

      doc.setFillColor(246, 249, 255);
      doc.rect(0,0,pageWidth,60,'F');
      doc.setFontSize(18);
      doc.setTextColor(15,23,42);
      doc.text('EMI Repayment Schedule', margin, 40);

      y = 80;
      const cardW = 140; const cardH = 40; const gap = 12;
      const cards = [
        {label:'Loan Amount', value: fmt(loan), color: [14,165,233]},
        {label:'Rate (%)', value: String(rate), color: [16,185,129]},
        {label:'Tenure (yrs)', value: String(years), color: [234,179,8]},
        {label:'Initial EMI', value: fmt(initialEmi), color: [99,102,241]}
      ];
      let x = margin;
      cards.forEach(c=>{
        doc.setFillColor(c.color[0], c.color[1], c.color[2]);
        doc.roundedRect(x, y, cardW, cardH, 6, 6, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(10);
        doc.text(c.label, x + 10, y + 14);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.text(c.value, x + 10, y + 30);
        doc.setFont(undefined, 'normal');
        x += cardW + gap;
      });

      y += cardH + 18;

      const head = hasPart ? [['Month','EMI','Principal','Interest','Part Payment','Outstanding']] : [['Month','EMI','Principal','Interest','Outstanding']];
      const body = schedule.map(r => hasPart ? [r.month, r.emi, r.principalPaid, r.interestPaid, r.partPayment, r.outstanding] : [r.month, r.emi, r.principalPaid, r.interestPaid, r.outstanding]);

      doc.autoTable({
        startY: y, head: head, body: body, styles: { fontSize: 9 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: margin, right: margin },
        didDrawPage: function (data) {
          const page = doc.internal.getNumberOfPages();
          doc.setFontSize(9); doc.setTextColor(120);
          doc.text('Page ' + page, data.settings.margin.left, doc.internal.pageSize.height - 10);
        },
        theme: 'grid'
      });

      doc.save('emi_schedule.pdf');
    }

    // Events
    document.getElementById('addPp').addEventListener('click', addPayment);
    document.getElementById('clearPps').addEventListener('click', clearPayments);
    [loanEl, rateEl, yearsEl, modeEl].forEach(el => el.addEventListener('input', computeAndRender));
    document.getElementById('downloadXLSX').addEventListener('click', exportXLSX);
    document.getElementById('downloadPDF').addEventListener('click', exportPDF);

    // First render
    renderPayments();
    computeAndRender();
  </script>
</body>
</html>
